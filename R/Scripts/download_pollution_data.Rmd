---
title: "Download pollution data"
output: html_notebook
---

# Data description and access

This document contains the code used to download the data on air pollution. The data comes from the European Environment agency and is accessible through this URL: https://discomap.eea.europa.eu/map/fme/AirQualityExport.htm. The web page contains information on how to download the data. 

The process to access the data is as follows:

- Write a simple request URL taking the form: https://fme.discomap.eea.europa.eu/fmedatastreaming/AirQualityDownload/AQData_Extract.fmw?CountryCode=FR&CityName=&Pollutant=5018&Year_from=2020&Year_to=2020&Station=&Samplingpoint=&Source=E1a&Output=HTML&UpdateDate=&TimeCoverage=Year. Note that
parameters can be left blank to access all the values for this parameter (here `CityName` is left blank. 
- This URL leads to the right URL to get the data (year by year)

# Packages and so on

```{r setup, include=FALSE, results='hide', warning=FALSE}
library(knitr)
opts_chunk$set(fig.path = "images/",
               cache.path = "cache/",
               cache = FALSE,
               echo = TRUE,
               message = FALSE,
               warning = FALSE)  
```  

```{r}
library(tidyverse)
library(httr)
library(lubridate)
```

# Downloading the data

First, generate a request URL with desired parameter values. It will provides a set of URLs to access the data. Then, store the list of URLs it in a vector. Finally, access all the URLs and merge the outputs to get a unique data frame.

## Function

```{r}
download_pollution <- function(country = "", city = "", pollutant = "", begin = "", end = "") {
  request_url <- str_c("https://fme.discomap.eea.europa.eu/fmedatastreaming/AirQualityDownload/AQData_Extract.fmw?CountryCode=",  country, "&CityName=", city, "&Pollutant=", pollutant, "&Year_from=", begin,"&Year_to=", end, "&Station=&Samplingpoint=&Source=E1a&Output=TEXT&UpdateDate=&TimeCoverage=Year")

  vector_urls <- GET(request_url) %>% 
    content(as = "text") %>% 
    str_split("\r\n") %>% 
    as_vector() %>% 
    head(-1) #last value empty: delete

  data <- NULL
  for (url in vector_urls) {
    temp <- tempfile()
    download.file(url, temp)
    data <- data %>% 
      rbind(read_csv(temp))
  }
  return(data)
}
```

## Download

```{r message=FALSE}
whole_data <- download_pollution(country = "FR", city = "Paris", pollutant = "5018", begin = 2013, end = 2020)
```

# Cleaning the data

There are several units of measurement, I convert everything in $\mu g/m^3$.

For now, I assume that we only need a limited subset of variables (AirPollutant, AirQualityStation, Concentration, DatetimeBegin and DatetimeEnd)

```{r}
data_clean <- whole_data %>% 
  mutate(
    Concentration = ifelse(UnitOfMeasurement == "ng/m3", Concentration*1000, Concentration),
    DatetimeBegin = as_datetime(DatetimeBegin),
    DatetimeEnd = as_datetime(DatetimeEnd)
  ) %>% 
  select("AirPollutant", "AirQualityStation", "Concentration", "DatetimeBegin", "DatetimeEnd")
```


# Covariates






